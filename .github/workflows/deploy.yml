name: deploy
run-name: Deploying site
on: [push]
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 4
    steps:
      - uses: actions/checkout@v4
      - name: Set environment for branch
        run: |
          DEPLOY_DOMAIN="devtools.eidr.org"
          if [[ "$GITHUB_REF_NAME" == release-* ]]; then
            DEPLOY_DOMAIN="tools.eidr.org"
          else
            case "$GITHUB_REF_NAME" in
              develop) DEPLOY_SERVER="35.166.60.179" && DEPLOY_DOMAIN="sb2tools.eidr.org";;
              main) DEPLOY_DOMAIN="betatools.eidr.org" ;;
            esac
          fi
          echo "$DEPLOY_SERVER" > ./server.txt
          echo "ENV=local" > ./client/.env
          echo "NODE_ENV=production" >> ./client/.env
          echo "CORS_CLIENT=https://$DEPLOY_DOMAIN"  >> ./client/.env
          echo "DEPLOY_DOMAIN=$DEPLOY_DOMAIN" >> ./client/.env
          cat ./client/.env
          cp ./client/.env ./server/.env
          # redirect and port?
      - name: Create SSH key
        run: |
          mkdir -p ~/.ssh/
          chmod 700 ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
        shell: bash
        env:
          SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
      - run: bash ./ops/deploy.sh
